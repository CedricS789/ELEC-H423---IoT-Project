\chapter{Threat Model}

\section{Data flow diagram}

In the first chapter, we discussed about the project concept where one ESP32 is used as a data publisher mimicking the data collection of a room
we would like the thermal conditions to be controlled via a command center, which is the alias for our second ESP32. \\
The acquised data are sent from our ESP32 "publisher" to a MQTT server, installed on our machine for the example.  The second ESP32 is subscribed
to the MQTT server, receiving the published data and in charge of monitoring - controlling the room conditions.  Those data are displayed
on another MQTT server able to plot data evolution. \textbf{Speak about TCP protocol ? - first handshake} \newline
The data flow is shown on the figure ~\ref{fig:Diagram_flow}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{Pic/Diagram_flow.PNG}
    \caption{Data flow diagram}
    \label{fig:Diagram_flow}
\end{figure}

For completeness, we will consider our data as highly sensitive - with strict security needs - where the room thermal regulation cannot be 
vulnerable to seizing control attacks or unstablizing temperature attacks for example. \\
We would therefore need to mitigate all types of attack by integrating a security strategy considering the ressources constraints dependent on 
the hardware used - in our case, the ESP32 devkit with :

\begin{enumerate}
    \item 4MB flash memory
    \item 520KB RAM
    \item Dual-core 32-bit processor
\end{enumerate}

Thus HTTPS / TLS protocol are not adapted for our devices and key cryptoghraphy containing complex mathematical operation like RSA cannot 
be implemented.  This suitable security strategy counter acting the whole span of threats while fitting into the hardware
 and meeting the decyphering process speed will be discussed in the last chapter namely the "Security mitigation".

Before treating about the security strategy, we would need to identify the security threats our model needs to deal with.  The STRIDE model will
be used in this perspective in the next section.

Figure ~\ref{fig:Diagram_flow_STRIDE}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{Pic/Diagram_flow_STRIDE.PNG}
    \caption{STRIDE model verification for project data flow}
    \label{fig:Diagram_flow_STRIDE}
\end{figure}


\section{STRIDE Threat Model}

The STRIDE threat model is an approach used to identify and categorize potential security threats and vulnerabilities in software systems. Developed by Microsoft, the acronym STRIDE represents six main categories of threats. These figures below illustrate all categories, their description and how they are mitigated in the project.\\

\begin{figure}[h]
\includegraphics[width=0.7\textwidth]{Pic/STRIDE.PNG}
\caption{STRIDE model and threats localization}
\label{fig:STRIDE}
\end{figure}

\begin{table}[h!]
    \centering
    \caption{STRIDE Threat Model and Security Mitigations for ESP32-MQTT Setup}
    \label{tab:stride_mitigation}
    \begin{tabular}{>{\raggedright\arraybackslash}p{1.7cm} >{\raggedright\arraybackslash}p{3cm} >{\raggedright\arraybackslash}p{3.5cm} >{\raggedright\arraybackslash}p{5.5cm}}
        \toprule
        \textbf{STRIDE Category} & \textbf{Threat Description} & \textbf{Attacked Component/Data Flow} & \textbf{Security Mitigation (Protocol)} \\
        \midrule
        \textbf{Spoofing} (Authentication) & An attacker impersonates a legitimate ESP32 device or the MQTT Server to inject false data or commands. & ESP32 $\leftrightarrow$ Server Communication & \textbf{Authentication} using a \textbf{Message Authentication Code (MAC)}, such as HMAC-SHA256, to verify the sender's identity with a shared secret key derived from PBKDF2. \\
        \midrule
        \textbf{Tampering} (Integrity) & Data (sensor readings) is intercepted and modified while in transit over the network. & Sensor Data $\to$ Server, Control Commands & \textbf{Integrity} enforced by the MAC (HMAC-SHA256). The receiver recalculates and compares the MAC to detect any alteration. \\
        \midrule
        \textbf{Information Disclosure} (Confidentiality) & An attacker eavesdrops on the network and reads sensitive data (Temperature,Humidity...). & All Communication over the Network & \textbf{Encryption} of the MQTT payload using AES-128. An additional layer is provided by Port Knocking to make sniffing and channel monitoring harder. \\
        \midrule
        \textbf{Denial of Service (DoS)} & An attacker floods the ESP32 or MQTT server with excessive traffic or requests, consuming resources. & ESP32 or Server Resources & \textbf{Rate-limiting} controls on the MQTT broker (assumption) and the use of Port Knocking to obscure the communication channel, reducing the window for targeted attacks. \\
        \midrule
        \textbf{Repudiation} (Non-Repudiation) & A legitimate device or the server denies having sent a critical or malicious message. & All Communication & The HMAC proves the message's origin from the authentic sender, and the counter ensures a definitive record of sequential messages, preventing the sender from denying transmission. \\
        \midrule
        \textbf{Elevation of Privilege} (Authorization) & A compromised device gains access to MQTT topics or capabilities it should not have permission for. & ESP32 $\leftrightarrow$ Server Communication, MQTT Topic Subscriptions & Strict Authorization controls on the MQTT broker (assumption) and the requirement to correctly decrypt the secret key via the Morse code sequence before publishing data. \\
        \bottomrule
    \end{tabular}
\end{table}

